---
layout: default
title: GIT + Rails + Rcov + Jenkins = super simple CI (continuous integration)
date: 2012-04-24 11:00:33.000000000 +02:00
categories:
- Coding
- Git
- Rails
- Server
- Tools
tags:
- ci
- continuous integratio
- git hooks
- hudson
- post-update
- rails
- rcov
status: publish
type: post
published: true
meta:
  _edit_last: '29044201'
  publicize_results: a:1:{s:7:"twitter";a:1:{i:219923888;a:2:{s:7:"user_id";s:13:"0r1g4m14dd1c7";s:7:"post_id";s:18:"194735281025458176";}}}
  _wpas_done_twitter: '1'

---
<p><a href="https://codenfold.files.wordpress.com/2012/04/headshot.png"><img class="alignright size-full wp-image-216" title="jenkins" src="assets/headshot.png" alt="" width="96" height="96" /></a>Let's set up a <strong>simple and easy</strong> to configure continuous integration environment to <strong>run automated tests and generate coverage reports</strong> for our code.</p>
<p>The setup consists of three steps. In the end we'll have an automated setup which requires no further steps to use it!</p>
<h1>Initial Situation</h1>
<p>We have a <a href="https://rubyonrails.org/">Ruby on Rails</a> project under <a href="https://git-scm.com/">GIT</a> source control on which we want to run tests and generate coverage reports using <a href="https://jenkins-ci.org/">Jenkins</a>.</p>
<p>The repository consists of several branches, but the main (and interesing) branches are <em>development</em>, <em>staging</em> and <em>master</em>.</p>
<p>Tests and coverage reports should be generated for the <em>staging</em> and <em>master</em> branches every time something is commited into them.</p>
<p>So far so good, let's get started.</p>
<h1>Prerequirements</h1>
<p>I'm assuming that you already have the following environment up and running, If not - well...</p>
<ul>
<li>A RoR project hosted on a central GIT repository</li>
<li>A GIT repository server (it also works without one, but this is the preferred setup and we're using hooks so you must be able to edit them)</li>
<li>A Jenkins build server (with git and ruby running) and the following plugins installed
<ul>
<li><a href="https://wiki.hudson-ci.org/display/HUDSON/Ruby+Plugin">Hudson ruby plugin</a></li>
<li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Rake+Plugin">Jenkins Rake plugin</a></li>
<li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Ruby+Metrics+Plugin">Jenkins ruby metrics plugin</a></li>
<li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin">Jenkins GIT plugin</a></li>
</ul>
</li>
</ul>
<h1>1st - Configure the build job</h1>
<p>I suggest you include the rcov gem in your Gemfile under the test group to assure it's getting installed on the build server. If you don't want to, install the gem on your build server.</p>
<p>[sourcecode language="ruby"]<br />
group :test do<br />
  ...<br />
  gem 'rcov'<br />
  ...<br />
end<br />
[/sourcecode]</p>
<p>Create a new jenkins <strong>build job</strong> for your project and configure it.</p>
<ul>
<li>Select <em>Git</em> under Source-Code-Management and add your build branches. In your case they would be <em>staging</em> and <em>master</em></li>
<li>Add <em>execute shell</em> as build step and paste the following script, adjust the steps as you see fit for your case<br />
[sourcecode language="bash"]<br />
# setup env<br />
export RAILS_ENV=test</p>
<p># Prepare for rcov<br />
[ -d &quot;coverage&quot; ] &amp;&amp; rm -rf coverage<br />
mkdir coverage</p>
<p># install bundle<br />
bundle install --deployment --without development</p>
<p># prepare database<br />
mv config/database.example.yml config/database.yml<br />
bundle exec rake db:drop<br />
bundle exec rake db:create<br />
bundle exec rake db:schema:load<br />
bundle exec rake db:seed</p>
<p># run tests and coverage<br />
bundle exec rake test<br />
bundle exec rake rcov<br />
[/sourcecode]</li>
<li>Check the <em>Publish Rcov report</em> option under <em>post-build-actions  </em>and set the <em>Rcov report directory</em> to <em>coverage<br />
</em>Adjust the Coverage metric targets as desired but the default values are a good start.</li>
</ul>
<div>That's it for the basic jenkins job configuration, you can of course define other options as well, I for example use e-mail notifications as well.</div>
<h1>2nd - Configure git hook for to trigger build process</h1>
<p>Now, I want my build job to be triggered every time I merge into the staging or master branch. To achieve this I'm using the git <em>post-update</em> hook. You can, of course use the hook on your local machine without using a central GIT server. It suffices if you're working alone or simply can't edit GIT hooks on your repository server (which is a sad thing).</p>
<p>But let's assume we have a central GIT server, so add the following script as <em>post-update</em> hook on your git server. The hooks are located in the git repository directory under <em>your-repository/hooks/post-update. </em>You can simply replace the file located there, important is the filename <em>post-update</em>.</p>
<p>[sourcecode]<br />
#!/bin/sh<br />
# trigger jenkins build after post-update into specific branch<br />
#stages='staging|master'</p>
<p>#if [[ `git rev-parse --abbrev-ref HEAD` =~ $stages ]]; then<br />
	curl https://hudson.yourdomain.com/job/Your-Job/build?delay=0sec<br />
#fi<br />
[/sourcecode]</p>
<p>Finally, the hook must be marked as executable, else it won't work:</p>
<p>[sourcecode language="bash"]<br />
chmod +x post-update<br />
[/sourcecode]</p>
<p>And this part's done too!</p>
<h1>3rd - Develop, merge, push</h1>
<p>The setup is complete, every time something ist commited into the staging or master branch and pushed to the GIT server your jenkins job gets triggered which in turn runs your tests and generates rcov coverage reports.</p>
