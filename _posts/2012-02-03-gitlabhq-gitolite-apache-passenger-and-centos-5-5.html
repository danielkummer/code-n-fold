---
layout: default
title: Gitlabhq, Gitolite, Apache Passenger and Centos 5.5
date: 2012-02-03 19:00:19.000000000 +01:00
categories:
- Git
- Tools
tags:
- apache2
- git
- gitlabhq
- gitolite
- mysql
- passenger
- redis
status: publish
type: post
published: true
meta:
  _edit_last: '29044201'
  _thumbnail_id: '116'
  publicize_results: a:1:{s:7:"twitter";a:1:{i:219923888;a:2:{s:7:"user_id";s:13:"0r1g4m14dd1c7";s:7:"post_id";s:18:"165497896110792704";}}}
  _wpas_done_twitter: '1'

---
<p>Getting the great project <a href="https://gitlabhq.com/">gitlabhq</a>, a web frontend for git based on gitolite and rails to run under Centos 5.5 can be quite frustrating but I managed to get the whole system up and running.</p>
<p>To get started I've read the installation manual on the<a href="https://github.com/gitlabhq/gitlabhq/wiki"> gitlabhq wiki page</a> as well as serveral other blogs and resources in order to cope with the bugging Centos 5.5 problems and outdated packages. (I'll admit I don't like this OS very much...)</p>
<p>There are quite a lot of tutorials and manuals got get gitlabhq working but most of them are either not intended for CentOS or don't provide help for certain pitfalls...Here I'll provide a step by step explanation on how I did it.</p>
<h1>Target Configuration</h1>
<p>My intended target configuration for the gitlabhq server is as follows:</p>
<ul>
<li>git 1.7.4.1</li>
<li>ruby 1.9.2</li>
<li>mysql 5.5.20</li>
<li>redis 2.4.6</li>
<li>apache 2</li>
<li>mod_passenger 3.0.11</li>
<li>gitlabhq 2.1 stable</li>
</ul>
<div><span style="font-size:14px;line-height:23px;">I use mysql as database backend instead of the pre-configured sqlite3 setup gitlabhq uses by default. It's just the better choice for a production environment.</span></div>
<div></div>
<h1>Preinstalled software</h1>
<p>I expect you've got a Centos 5.5 System up and running with the following software preinstalled:</p>
<ul>
<li>apache2</li>
<li>git 1.7.x</li>
<li>python 2.4</li>
<li>mysql 5.5</li>
</ul>
<h1>Installation and Configuration</h1>
<p>So let's start with the installation and configuration process. If you follow the guide top-down you'll have a running gitlabhq setup in notime!</p>
<h2>Prerequirements</h2>
<p>We start by installing the overall prerequired CentOS and source packages.</p>
<h3>CentOS Packages</h3>
<p>Firstly install required CentOS packages like the openssh-server and other packages required for the building or installation processes.</p>
<p>[sourcecode light="true"]<br />
sudo yum install -y git openssh-server curl-devel openssl-devel httpd-devel apr-devel apr-util-devel libzlib-ruby zlib-devel python-devel python-setuptools libicu-devel gcc-c++ gcc ruby-devel libxml2 libxml2-devel libxslt libxslt-devel<br />
[/sourcecode]</p>
<h3>Source Packages</h3>
<h4>Libyaml</h4>
<p>You have to compile the yaml library directly from source, there are no current packages available for CentOS.</p>
<p>[sourcecode light="true"]<br />
wget https://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz<br />
tar xzvf yaml-0.1.4.tar.gz<br />
cd yaml-0.1.4<br />
./configure --prefix=/usr/local<br />
make &amp;&amp; make install<br />
[/sourcecode]</p>
<h4>Redis</h4>
<p>It's the same with the redis key-value store, compile it from source to get a current version, redis is used by gitlabhq.</p>
<p>[sourcecode light="true"]<br />
wget https://redis.googlecode.com/files/redis-2.4.6.tar.gz<br />
tar xvfz redis-2.4.6.tar.gz<br />
cd redis-2.4.6<br />
make &amp;&amp; sudo make install<br />
[/sourcecode]</p>
<p>There are sed scripts available to customize the redis standard configuration, just execute the command line statements below. It enables the redis daemon process and outputs logs to /var/log/redis.log:</p>
<p>[sourcecode light="true"]<br />
mkdir /etc/redis /var/lib/redis<br />
sed -e &quot;s/^daemonize no$/daemonize yes/&quot; -e &quot;s/^dir \.\//dir \/var\/lib\/redis\//&quot; -e &quot;s/^loglevel debug$/loglevel notice/&quot; -e &quot;s/^logfile stdout$/logfile \/var\/log\/redis.log/&quot; redis.conf &gt; /etc/redis/redis.conf<br />
[/sourcecode]</p>
<p>Fortunately there is an init script for redis and Centos available, you can get it from github.com:</p>
<p>[sourcecode light="true"]<br />
wget https://raw.github.com/gist/257849/9f1e627e0b7dbe68882fa2b7bdb1b2b263522004/redis-server<br />
sed -i &quot;s/usr\/local\/sbin\/redis/usr\/local\/bin\/redis/&quot; redis-server<br />
chmod u+x redis-server<br />
mv redis-server /etc/init.d<br />
/sbin/chkconfig --add redis-server<br />
/sbin/chkconfig --level 345 redis-server on<br />
/sbin/service redis-server start<br />
[/sourcecode]</p>
<h5>Testing Redis Installation</h5>
<p>Test the redis installation by opening a telnet connection and setting/reading a key value pair:</p>
<p>[sourcecode light="true"]<br />
telnet 127.0.0.1 6379<br />
set attitude:today &quot;happy&quot;<br />
get attitude:today<br />
[/sourcecode]</p>
<h5> Installation Resque Post-Receive Git Hooks</h5>
<p>If you'd like to use the Redis/Reque post-receive hooks with gitlab, the following command starts resque detached from the current terminal session:</p>
<p>[sourcecode light="true"]<br />
nohup bundle exec rake environment resque:work QUEUE=* VVERBOSE=1 RAILS_ENV=production PIDFILE=tmp/pids/resque_worker_QUEUE.pid<br />
[/sourcecode]</p>
<h3>Sqlite3</h3>
<p>Although I'm not using Sqlite3 in my configuration I'll explain the installation process anyway in case you stick with Sqlite3 instead of MySQL for the database backend. As expected, the Centos 5.5 Sqlite package is outdated and has to be compiled from source:</p>
<p>[sourcecode light="true"]<br />
wget https://www.sqlite.org/sqlite-autoconf-3070800.tar.gz<br />
tar -zxvf sqlite-autoconf-3070800.tar.gz<br />
cd sqlite-autoconf-3070800<br />
./configure --prefix=/opt/sqlite3 &amp;&amp; make &amp;&amp; make install<br />
[/sourcecode]</p>
<p>To finish the setup process the new shared libraries have to be copied to the libraries search path:</p>
<p>[sourcecode light="true"]<br />
cp -p /opt/sqlite3/lib/libsqlite3.so.0 /usr/lib64<br />
cp -p /opt/sqlite3/lib/libsqlite3.so.0 /usr/lib<br />
[/sourcecode]</p>
<h2>Ruby</h2>
<p>As we know by now the way to go is to compile the software from source to get a current version, it's no different for our beloved Ruby...</p>
<p>[sourcecode light="true"]<br />
wget https://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.2-p290.tar.gz<br />
tar xzvf ruby-1.9.2-p290.tar.gz<br />
cd ruby-1.9.2-p290<br />
./configure --prefix=/usr/local --enable-shared --disable-install-doc --with-opt-dir=/usr/local/lib<br />
make &amp;&amp; make install<br />
[/sourcecode]</p>
<p>Add the ruby binary path (/usr/local/bin) to the gobal paths:</p>
<p>[sourcecode light="true"]<br />
echo 'pathmunge /usr/local/bin' &gt; /etc/profile.d/ruby.sh<br />
chmod +x /etc/profile.d/ruby.sh<br />
[/sourcecode]</p>
<p>And update the gem system, just to be sure...</p>
<p>[sourcecode light="true"]<br />
gem update --system<br />
[/sourcecode]</p>
<h2>Gitolite</h2>
<p>The gitolite installation manuals can be quite perplexing and complicated. But if you get down to it the installation process is quite straight forward:</p>
<p>Create a new user to be used by gitolite</p>
<p>[sourcecode light="true"]<br />
useradd --shell /bin/bash --comment 'git version control' -m git<br />
[/sourcecode]</p>
<p>Create a corresponding group and add the newly created user to it</p>
<p>[sourcecode light="true"]<br />
usermod -a -G git git<br />
[/sourcecode]</p>
<p>Generate an ssh-key for the newly created git user <strong>without a password!</strong></p>
<p>[sourcecode light="true"]<br />
su git<br />
ssh-keygen -t rsa<br />
[/sourcecode]</p>
<p>Copy the created key to the git user home directory replacing the default name with the username</p>
<p>[sourcecode light="true"]<br />
cp .ssh/id_rsa.pub git.pub<br />
[/sourcecode]</p>
<p>Clone the gitolite repository</p>
<p>[sourcecode light="true"]<br />
sudo -u git -H git clone git://github.com/gitlabhq/gitolite /home/git/gitolite<br />
[/sourcecode]</p>
<p>Install gitolite by using the earlier copied git public key for the initial setup</p>
<p>[sourcecode light="true"]<br />
sudo -u git -H /home/git/gitolite/src/gl-system-install<br />
sudo -u git -H sh -c &quot;PATH=/home/git/bin:$PATH; gl-setup ~/git.pub&quot;<br />
[/sourcecode]</p>
<p>During the installation you're prompted to edit the gitolite config file. Replace the repository umask value as described below</p>
<p>[sourcecode light="true"]<br />
$REPO_UMASK = 0007;<br />
[/sourcecode]</p>
<p>As the last step fix the repository directory permissions and owner</p>
<p>[sourcecode light="true"]<br />
sudo chmod -R g+rwX /home/git/repositories/<br />
sudo chown -R git:git /home/git/repositories/<br />
[/sourcecode]</p>
<h3>Testing Gitolite</h3>
<p>This step is <strong>mandatory</strong> in order to get the localhost entry in the ssh known_keys file made</p>
<p>To test the gitolite installation clone the gitolite admin repository on the server into the tmp folder.</p>
<p>You have to do this using the git user, only this user has its public key in gitolite installed at the moment.</p>
<p>[sourcecode light="true"]<br />
git clone git@localhost:gitolite-admin.git /tmp/gitolite-admin<br />
[/sourcecode]</p>
<p>If everything is in order you can delete the cloned repository afterwards...</p>
<p>[sourcecode light="true"]<br />
rm -rf /tmp/gitolite-admin<br />
[/sourcecode]</p>
<h2>Gitlabhq</h2>
<p>Wer're finally getting to the gitlabhq installation. Let's start with the prerequired python and ruby libraries:</p>
<p>[sourcecode light="true"]<br />
easy_install pip<br />
sudo pip install pygments<br />
sudo gem install bundler<br />
[/sourcecode]</p>
<p>If you're using Sqlite3 as db backend, install the sqlite3 gem with the following command</p>
<p>[sourcecode light="true"]<br />
gem install sqlite3 -v '1.3.4' -- --with-sqlite3-dir=/opt/sqlite3<br />
[/sourcecode]</p>
<p>This is also a good chance to install the by gitlabhq required charlock holmes gem</p>
<p>[sourcecode light="true"]<br />
sudo gem install charlock_holmes -v '0.6.8'<br />
[/sourcecode]</p>
<p>If you're getting SSL certificate verification errors use the no verify global variable and try the gem install command again:</p>
<p>[sourcecode light="true"]<br />
export GIT_SSL_NO_VERIFY=true<br />
[/sourcecode]</p>
<p>Now clone the gitlab repository and install the gems (as user git)</p>
<p>[sourcecode light="true"]<br />
cd<br />
git clone -b stable git://github.com/gitlabhq/gitlabhq.git<br />
cd gitlabhq<br />
[/sourcecode]</p>
<h3>MySQL Backend</h3>
<p>If you're using the preconfigured Sqlite3 backend you can skip this step and proceed directly with the bundle install command further below.<br />
But if you decide to use MySQL as database backend you'll have to make some small changes to the gitlabhq configuration as well as initialize the mysql database and add a query user for gitlabhq.<br />
First, edit the config/database.yml file and configure a production environment similar to this:</p>
<p>[sourcecode light="true"]<br />
production:<br />
  adapter: mysql2<br />
  username: gitlab<br />
  password: &quot;your_db_password&quot;<br />
  host: localhost<br />
  database: gitlab<br />
[/sourcecode]</p>
<p>Second, you have to add the mysql2 gem to the Gemfile in the gitlabhq folder (you can remove the sqlite3 gem dependency)</p>
<p>[sourcecode light="true"]<br />
gem &quot;mysql2&quot;<br />
[/sourcecode]</p>
<p>To be sure it works, install the mysql2 gem separately:</p>
<p>[sourcecode light="true"]<br />
gem install mysql2<br />
[sourcecode light=&quot;true&quot;]</p>
<p>I expect you have a MySQL server up and running that's why I'm only describing the initial database setup.<br />
Login into the mysql client using the root user</p>
<p>[sourcecode light=&quot;true&quot;]<br />
mysql -u root -p<br />
[/sourcecode]</p>
<p>Create a user and a database for gitlabhq</p>
<p>[sourcecode light="true"]<br />
CREATE USER gitlab@localhost IDENTIFIED BY 'here_is_the_db_password';<br />
CREATE DATABASE IF NOT EXISTS gitlab;<br />
GRANT ALL PRIVILEGES ON gitlab . * TO gitlab@localhost;<br />
[/sourcecode]</p>
<h3>Install bundle, load tables and initial data</h3>
<p>Now proceed with the finishing touch; install the bundles and execute the initial db setup</p>
<p>[sourcecode light="true"]<br />
bundle install --without development test<br />
bundle exec rake db:setup RAILS_ENV=production<br />
bundle exec rake db:seed_fu RAILS_ENV=production<br />
[/sourcecode]</p>
<h2>Apache2 mod_passenger</h2>
<p>I'm against running gitlabhq using the rails provided server so I'll be using passenger instead...<br />
Let's assume you're using a working apache2 installation with the module configurations stored under <em>/etc/httpd/conf.d</em> and a vhost setup with the vhost configurations stored under <em>/etc/httpd/hosts</em>.</p>
<p>Start by installing the passenger gem and passenger itself</p>
<p>[sourcecode light="true"]<br />
gem install passenger<br />
passenger-install-apache2-module<br />
[/sourcecode]</p>
<p>Copy the generated loadmodule statements to a new module file and store it under <em>/etc/httpd/conf.d/passenger.conf</em></p>
<p>[sourcecode light="true"]<br />
LoadModule passenger_module /usr/local/lib/ruby/gems/1.9.1/gems/passenger-3.0.11/ext/apache2/mod_passenger.so<br />
PassengerRoot /usr/local/lib/ruby/gems/1.9.1/gems/passenger-3.0.11<br />
PassengerRuby /usr/local/bin/ruby<br />
[/sourcecode]</p>
<p>Here's an example of a working vhost configuration, you can copy paste and adjust it to your needs:</p>
<p>[sourcecode light="true"]</p>
<p>        ServerName gitlabhq.yourhost.com<br />
        DocumentRoot /home/git/gitlabhq/public</p>
<p>            AllowOverride All<br />
            Options -MultiViews</p>
<p>        CustomLog logs/gitlab/access combined<br />
        ErrorLog  logs/gitlab/error<br />
        ServerAdmin info@yourhost.com<br />
        RackBaseURI /<br />
        RackEnv production</p>
<p>[/sourcecode]</p>
<p>It's extremely important to add the apache user to the git user group to prevent access problems:</p>
<p>[sourcecode light="true"]<br />
usermod -a -G git apache<br />
[/sourcecode]</p>
<h1>Resources</h1>
<p>I've used the following web resources to help me with my installation:</p>
<table>
<tbody>
<tr>
<th>URL</th>
<th>Description</th>
</tr>
<tr>
<td><a href="https://github.com/gitlabhq/gitlabhq/wiki/Ubuntu.stable" rel="nofollow">Gitlabhq</a></td>
<td>Ubuntu linux installation tutorial</td>
</tr>
<tr>
<td><a href="https://github.com/gitlabhq/gitlabhq/wiki/Gitolite" rel="nofollow">Gitolite (Gitlabhq)</a></td>
<td>Tutorial for gitolite installation on ubuntu linux</td>
</tr>
<tr>
<td><a href="https://sites.google.com/site/senawario/home/gitolite-tutorial" rel="nofollow">Gitolite Installation Tutorial</a></td>
<td>In depth installation tutorial for gitolite</td>
</tr>
<tr>
<td><a href="https://www.ebrueggeman.com/blog/install-redis-centos-56" rel="nofollow">Redis</a></td>
<td>Installation tutorial for redis on CentOS 5.6</td>
</tr>
<tr>
<td><a href="https://nokogiri.org/tutorials/installing_nokogiri.html" rel="nofollow">Nokogiri</a></td>
<td>Installation tutorial for Nokogiri</td>
</tr>
<tr>
<td><a href="https://www.shiftedbytes.com/2011/04/install-ruby-192-passenger-on-centos-55.html" rel="nofollow">Ruby 1.9.2 on CentOS 5.5</a></td>
<td>Installation tutorial for Ruby and Passenger on CentOS 5.5</td>
</tr>
</tbody>
</table>
<h1>Pitfalls</h1>
<p>One sad thing about gitlabhq is the overall 500 error page. You won't get detailed  information on what went wrong it just says "there was a problem, check your config".</p>
<p>The following thing is essential if you're having problem like for example creating new repositories and using mod_passenger:</p>
<p><strong>The user running passenger must have write access to the gitolite repository folder! If he doesn't have the permissions - fail!</strong></p>
<p>For general problems try deleting the lockfiles generated by gitlabhq in the system temp directory:</p>
<p>[sourcecode light="true"]<br />
sudo rm -rf /tmp/gitlabhq-gitolite*<br />
[/sourcecode]</p>
<h1>Final Notes</h1>
<p>I'm using a slightly different setup in our company mainly because I've forked the gitlabhq project to make some company-related changes. In order to speed up development and deployment I'm using capistrano to deploy my gitlabhq fork to the server. I'm not posting information about it here because it's a special setup and won't be useful to you if you're not actively making changes to gitlabhq.</p>
<p>So that's it with this you should get gitlabhq working on your CentOS 5.5 system. If you've got problem or comments feel free to leave them here...</p>
