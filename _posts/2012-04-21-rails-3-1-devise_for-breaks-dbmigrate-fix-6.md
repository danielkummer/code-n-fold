---
layout: default
title: Rails 3.1 devise_for breaks db:migrate - fix
date: 2012-04-21
category: Programming
tags:
- devise
- rails
type: post
excerpt: Maybe you've encountered this incredible annoying devise bug which prevents you from successfully running rake tasks like db:migrate, db:schema:load and so on..
---

The generated error is always the same:

{% highlight bash %}

Devise error: ActiveRecord::StatementInvalid: Mysql2::Error: Table 'skills.users' doesn't exist: SHOW FIELDS FROM `users`

{% endhighlight %}

Sadly it's a chicken and egg problem, the root of the problem is a small, simple line in your routes.rb file:

{% highlight ruby %}

devise_for :users

{% endhighlight %}

I came to understand it has something to do with user model class methods and scopes which access the user model itself. When migrating devise scans the user model and tries something ( I regret to say I have no idea what...) but the tableÂ obviously doen't exist yet. The only working solution (pretty ugly but working though) is simply catching any exception generated by the **devise_for** statement:

{% highlight ruby %}

  begin
    devise_for :users
  rescue Exception =&gt; e
    puts &quot;Devise error: #{e.class}: #{e}&quot;
  end

{% endhighlight %}

If anyone knows the real root of the problem and the ultimate, beautiful solution don't hesitate and provide!
